# 四、期末架构



## 第二章 期末架构整体阐述

### 2.1、期末架构概述

![image-20200611102158558](http://book.luffycity.com/linux-book/%E6%9C%9F%E6%9C%AB%E6%9E%B6%E6%9E%84/pic/image-20200611102158558.png)

对于中小型站点，搭建LNMP集群环境足以支撑网站运行

```
接入层，nginx+keepalived 实现高可用性负载均衡
配置管理层，ansible对服务器集群进行批量部署，代码更新，文件分发，服务启停等
web业务层，nginx反向代理，结合php进行动静态请求分发
数据层，MySQL做好主从复制
共享存储，NFS+Rsync+定时任务，实现远程数据同步
```

#### Kickstart-Cobbler

既然要搭建网站架构运行环境，就得安装多台服务器，面对数量众多的服务器，如何批量安装操作系统呢？总不能手动的挨个装吧。

作为中小公司的运维，经常会遇到一些机械式的重复工作，例如：有时公司同时上线几十甚至上百台服务器，而且需要我们在短时间内完成系统安装。

常规的办法有什么？

*光盘安装系统===>一个服务器DVD内置光驱百千块，百台服务器都配光驱就浪费了，因为一台服务器也就开始装系统能用的上，以后用的机会屈指可数。用USB外置光驱，插来插去也醉了。* U盘安装系统===>还是同样的问题，要一台一台服务器插U盘。

*网络安装系统(ftp,http,nfs) ===>这个方法不错，只要服务器能联网就可以装系统了，但还是需要一台台服务器去敲键盘点鼠标。时刻想偷懒的我们，有没有更好的方法！*

高逼格的方法： *Kickstart* Cobbler

![image-20200611103328533](notes/image-20200611103328533.png)

### 2.2、期末架构之VPN

![image-20200611105220394](notes/image-20200611105220394.png)

### 2.3、期末架构之缓存与监控

#### 监控

![image-20200611105422508](notes/image-20200611105422508.png)

```
我们的职责
1.保障企业数据的安全可靠。
2.为客户提供7*24小时服务。
3.不断提升用户的体验。
在关键时刻，提前提醒我们服务器要出问题了
当出问题之后，可以便于找到问题的根源
```

#### 监控什么

```
远程管理服务器有远程管理卡，比如Dell idRAC，HP ILO，IBM IMM
查看硬件的温度/风扇转速，电脑有撸大师，服务器就有ipmitool。使用ipmitool实现对服务器的命令行远程管理
yum -y install OpenIPMI ipmitool  IPMI在物理机可以成功，虚拟机不行
CPU性能好不好、忙不忙可以用lscpu、uptime、top、htop。
内存够不够可以用free
磁盘剩多少写的快不快可以用df、dd、iotop
网络太卡找iftop， nethogs
```

### 2.4、期末架构tomcat与LVS

#### tomcat

```
Tomcat服务器是一个免费的开放源代码的Web应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP网页的首选。

Tomcat和Nginx、Apache(httpd)、lighttpd等Web服务器一样，具有处理HTML页面的功能，另外它还是一个Servlet和JSP容器，独立的Servlet容器是Tomcat的默认模式。不过，Tomcat处理静态HTML的能力不如Nginx/Apache服务器。

目前Tomcat最新版本为9.0。Java容器还有resin、weblogic等。
Tomcat官网：http://tomcat.apache.org/
```

![image-20200611105737377](notes/image-20200611105737377.png)

#### LVS

#### 负载均衡概念

```
负载均衡（Load Balance）集群提供了一种廉价、有效、透明的方法，来扩展网络设备和服务器的负载、带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性。
单台计算机无法承受大规模的并发访问或数据流量了，此时需要搭建负载均衡集群把流量分摊到多台节点设备上分别处理，即减少用户等待响应的时间又提升了用户体验；
7*24小时的服务保证，任意一个或多个有限后端节点设备宕机，不能影响整个业务的运行。
```

#### 为什么用LVS

```
工作在网络模型的7层，可以针对http应用做一些分流的策略，比如针对域名、目录结构，Nginx单凭这点可利用的场合就远多于LVS了。
最新版本的Nginx也支持4层TCP负载，曾经这是LVS比Nginx好的地方。
Nginx对网络稳定性的依赖非常小，理论上能ping通就就能进行负载功能，这个也是它的优势之一，相反LVS对网络稳定性依赖比较大。
Nginx安装和配置比较简单，测试起来比较方便，它基本能把错误用日志打印出来。LVS的配置、测试就要花比较长的时间了，LVS对网络依赖比较大。

简单一句话，当并发超过了Nginx上限，就可以使用LVS了。
日1000-2000W PV或并发请求1万以下都可以考虑用Nginx。
大型门户网站，电商网站需要用到LVS。
```

![image-20200611110822861](notes/image-20200611110822861.png)

学习lvs实现负载均衡的配置

### 2.5期末架构之持续集成

#### GIT/CI/CD

![image-20200611110959584](notes/image-20200611110959584.png)

```
持续集成是一种软件开发实践，即团队开发成员经常集成他们的工作，通常每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试)来验证，从而尽快地发现集成错误。许多团队发现这个过程可以大大减少集成的问题，让团队能够更快的开发优质的软件。
```

#### 概念

- **持续集成**(`Continuous Integration`)：**频繁地(一天多次)将代码集成到主干。**让产品可以快速迭代，同时还能保持高质量。它的核心措施是，代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失败，就不能集成。“持续集成并不能消除 Bug，而是让它们非常容易发现和改正。”
- **持续交付**(`Continuous Delivery`)：**频繁地将软件的新版本，交付给质量团队或者用户，以供评审。**如果评审通过，代码就进入生产阶段。持续交付可以看作持续集成的下一步。它强调的是，不管怎么更新，软件是随时随地可以交付的。
- **持续部署**(`continuous Deployment`)：**代码通过评审以后，自动部署到生产环境。**是持续部署是持续交付的下一步，持续部署的目标是，代码在任何时刻都是可部署的，可以进入生产阶段。

#### 持续集成的好处

- **自动化构建且状态对每个人可见**。可以使用`Maven`、`Gradle`等来实现自动化构建，可以在构建过程中实现自动化测试（前提是有写单元测试用例）。集成服务器在持续集成过程中发现问题可以及时发送警告给相关的干系人。
- **解放了重复性劳动。**自动化部署工作可以解放集成、测试、部署等重复性劳动，而机器集成的频率明显比手工高很多。
- **更快地发现和修复问题。**持续集成更早的获取变更，更早的进入测试，更早的发现问题，解决问题的成本显著下降。
- **更快的交付成果。**更早发现错误减少解决错误所需的工作量。集成服务器在构建环节发现错误可以及时通知开发人员修复。集成服务器在部署环节发现错误可以回退到上一版本，服务器始终有一个可用的版本。
- **减少手工的错误。**在重复性动作上，人容易犯错，而机器犯错的几率几乎为零。
- **减少了等待时间。**缩短了从开发、集成、测试、部署各个环节的时间，从而也就缩短了中间可以出现的等待时机。持续集成，意味着开发、集成、测试、部署也得以持续。
- **更高的产品质量。**集成服务器往往提供代码质量检测等功能，对不规范或有错误的地方会进行标致，也可以设置邮件和短信等进行警告。

#### 期末架构图

![image-20200611112658375](notes/image-20200611112658375.png)