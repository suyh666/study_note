# 四、期末架构



## 第一章 期末架构大型网站架构概述



### 1.1、网站架构背后的故事



 在上实际90年代初第一个Web服务的出现，开始做互联网站，互联网站发展至今已有了巨大的变化，全球有一半的人口使用互联网，人们的生活因为互联网有了巨大的改变。

 从百度、谷歌等信息搜索，从淘宝、京东网上购物到斗鱼、虎牙文化娱乐，互联网渗透人们的每个角落，且这种趋势还在加速。

 在互联网飞跃发展的过程里，电子商务的便捷背后缺是不堪重负的网站架构，一些B2C的网站逢促销必然宕机，铁道部电子购票网站频繁的故障和延迟更是把这种现象表现的淋漓尽致。

![image-20200610162507242](notes/image-20200610162507242.png)

一边是企业在网站技术上的投入，一边网站却在关键时刻，频繁宕机；

一边程序员夜以继日的加班，一边网站新功能上线故障，导致功能延缓上线；

一边是互联网业务快速发展挑战传统行业，一般是网站安全漏洞让网民胆战心惊；

打造一个高可用、高性能、易扩展、可伸缩且安全的网站，这是技术人员必须攻克，解决的难关。

### 1.2、网站架构特点

#### 大型网站架构特点

和传统企业应用系统相比，大型网站系统具备如下特点：

- **高并发，大流量**：需要扛得住高并发，大流量的用户访问。Google日均PV数35亿，日均IP访问数3亿；腾讯QQ同时在线用户数过亿；淘宝双11当天活动交易额过百亿，活动开始的第一分钟独立访问用户数达千万
- **高可用**：网站系统需要7*24小时不间断提供服务，大型网站的宕机事件通常都会成为新闻焦点，例如百度域名曾被黑客劫持无法访问。
- **海量数据，高可用数据库**：需要存储，管理海量数据，使用大量的服务器
- **世界各地用户分布广泛，网络环境复杂**：大型网站都是为全球用户提供服务，全球各地网络环境千差万别，即使国内也有多个运营商网络互通难的问题，面对海外用户还得假设海外数据中心。
- **服务器安全问题**：互联网的开放性，很容易受到黑客攻击，需要保护服务器安全，保证数据安全。
- **需求快速变更，发布频繁**：和传统应用比较不同，互联网产品为了快速满足市场需求，产品发布率很高，一天内网站发布几十次已是正常。
- **渐进式发展**：即使是世界级大型网站，也都是由小型架构慢慢演变而来，如阿里巴巴本是在马云家中客厅诞生。



### 1.3、网站结构敷衍化之应用分离



#### 网站架构演化发展历程

大型网站都是由小型网站发展而来，网站架构也是一样，从小网站逐步演化，最开始小网站访问人数很少，一台服务器即可完成工作。

此时应用程序，数据库，文件等所有资源都在一台服务器，也就是我们常见的LAMP、LNMP单机，使用各种开源软件和一台普通的服务器即可运行网站。

![image-20200610164114767](notes/image-20200610164114767.png)

#### 应用服务和数据库分离

随着网站业务的发展，用户量增多，一台服务器逐渐支撑不住，越来越多的用户访问导致网站响应速度变慢，越来越多的数据，导致存储空间不足。这时候应该把应用和数据分离，使用三台服务器的架构，分别运行应用服务器、文件服务器、数据库服务器。

这三台机器对硬件资源要求各不同，

- 应用服务器需要处理大量的业务逻辑，需要更强大，更快的CPU处理器
- 数据库服务器需要更快速的读写数据，因此需要更强大的磁盘和大内存
- 文件服务器要存储大量用户上传的文件，因此需要更大容量的硬盘。

![image-20200610164619601](notes/image-20200610164619601.png)

应用和数据分离后，不同作用的服务器承担不同的服务角色，各司其职，网站的并发处理能力和存储空间都得到了很大的改善，进一步支持网站业务。

但是随着公司发展，用户持续增长，网站此时架构又一次面临挑战，数据库压力太大，导致用户访问延迟，用户体验变差，老板又要拍板骂人了，运维架构师需要对网站架构进一步优化。

### 1.4、缓存服务器架构

#### 缓存

网站访问特点也逃不掉现实世界的二八定律：80%的业务访问集中在20%的商品数据上。

例如淘宝的用户最关注的都是成交量多，评价较好的商品；

百度搜索的也集中在当时的一些热门词汇；

很明显，对于网站的数据，就有热数据，冷数据之分，大部分的业务集中在一小部分数据上，那么如果把热门的数据缓存再内存中，是不是可以减轻数据库的访问压力，提高网站的整体访问效果呢，当然是可以。

PS：内存的I/O速度是远超于磁盘的

网站的缓存主要分两种：

- 缓存再应用服务器上的本地缓存
- 缓存放在专门的分布式缓存服务器上

本地缓存的访问更快，没有网络延时，但是应用服务器的内存有限，缓存的数据量有限制，而且会有缓存和应用程序争夺内存的情况。

远程分布式缓存可以采用集群的方案，部署较大内存的服务器作为专门的缓存服务器，可以在理论上实现内存不受限的扩容服务。当然这需要有成本代价。

![image-20200610182701236](notes/image-20200610182701236.png)

使用缓存后，数据库的访问压力得到有效的缓解，但是应用服务器在后续也有了瓶颈，主要使用负载均衡集群方式改善。



### 1.5、负载均衡集群

#### 服务器集群

 使用集群是网站解决高并发，海量请求的常见手段，俗话说三个臭皮匠，胜过诸葛亮。一台服务器的处理能力，存储空间都会有瓶颈，此时压根不要企图再去换一个更强大的服务器，对于大型网站而言，无论多么强大的服务器，都满足不了业务增长的需求，此时你的做法应该是再增加一个`臭皮匠`，也就是增加一台服务器，去分担原有服务器的压力。

 对于网站架构而言，通过增加机器的形式改善负载压力，就可以持续不断的改善系统性能，实现系统的可伸缩性。

 ![image-20200611092724820](notes/image-20200611092724820.png)

通过负载均衡调度服务器，将用户的请求分发到应用服务器集群中的任何一台机器上，根据用户访问量，来决定增/删集群中的服务器，以此来解决应用服务器的压力，不再是网站性能的瓶颈。



### 1.6、数据库读写分离

#### 数据库读写分离

 网站在使用缓存后，使得大部分数据的`读取`操作，不通过数据库就可以访问完成，但是也会有一部分的读取操作（例如缓存未命中，缓存过期）和全部的`写入`操作需要访问数据库，在网站达到一定规模之后，数据库因为负载压力过高而成为网站瓶颈。

 目前主流的数据库软件都提供了主从热备功能 ，配置两台数据库的主从关系，可以将一台数据库的数据，同步更新到另一台机器上。网站利用该功能，可以实现读写分离，减轻数据库负载压力。

 ![image-20200611093809263](notes/image-20200611093809263.png)

应用服务器进行`写入操作的时候，访问主数据库`，主数据库通过主从复制机制将数据更新同步到从数据库，这样当

应用服务器`读取数据的时候，可以通过从库获取数据`，以此实现数据读写分离，针对不同的网站业务，读，写的操作比率，也是不一样的，如电商类站点，用户浏览商品居多，读取居多；博客类站点，用户写入数据居多，需要依次进行不同的优化调整。

### 1.7、CDN与反向代理

#### 反向代理与CDN

 随着网站业务不断的发展，用户规模越来越大，由于中国复杂的网络环境，不同地区的用户访问体验，差距较大，若是你打开一个站点，等待时间稍微久了点，你可能下次就不愿意再访问该站点了，网站访问延迟和用户流失率成正比关系，为了留住用户，网站需要提升访问速度，配置`CDN和反向代理。`

 CDN和反向代理的基本原理都是基于缓存来实现，区别在于CDN部署在网络运营商的机房，用户在请求网站时，根据CDN地址可以访问离自己最近的机房，获取数据。

 反向代理则部署在网站的中心机房，当用户请求到达中心机房后，首先访问到的是反向代理服务器，如果代理服务器中有缓存数据，则直接返回给用户。

 ![image-20200611095007176](notes/image-20200611095007176.png)

使用CDN和反向代理的目的都是在与尽早的返回数据给用户，加快用户访问站点速度，也可以减轻后端服务器的负载压力。





### 1.8、网站架构阐述总结



#### 分布式数据库

 随着网站架构的越来越复杂，用户量继续增长，数据库这一层的压力，主从复制也无法满足需求了，这时候需要用分布式数据库，以及分布式文件系统。

 分布式数据库是指将网站数据库进行拆分，针对业务将数据库拆分，不同的业务数据存储在不同的物理服务器上。

![image-20200611095538095](notes/image-20200611095538095.png)

#### NoSQL与搜索引擎

随着网站业务越来越复杂，对于数据的存储和查询需求也更加复杂，网站这时候会用到非关系型数据库NoSQL和搜索引擎技术。

![image-20200611095918296](notes/image-20200611095918296.png)

#### 业务拆分

 大型网站由于业务复杂，会通过业务拆分的手段将网站的业务拆封成不同的产品线，例如一个电商网站可以把业务拆成【首页、订单、卖家、买家】等不同的产品线，归给不同的团队负责开发、维护。

 业务落实到技术上，也会根据产品线划分，吧网站应用拆封独立维护，流程图如下。

![image-20200611100629308](notes/image-20200611100629308.png)

大型网站架构的演化大致先到这，大多数的技术问题都可以得以解决。

大型网站架构的设计解决了海量数据的管理和高并发事务的处理，那么多现在很多大型公司开始建设云计算平台，把网站架构设计的计算作为一种资源进行出售，中小型的网站不再需要关心自己服务器的架构问题，只需要按需求付费，购买云计算平台提供的负载均衡、数据库高可用、消息队列、文件共享等等服务，即可完成自身业务需求的存储、计算资源等。

#### 网站架构价值观

 这个世界任何事都是从小到大的积累过程，任何一个网站都是从小型规模做起，网站的价值在于能给用户提供什么，能做什么，而不在于该网站是怎么设计出来的。

因此一个网站最需要做的就是为用户提供更好的服务，创造价值，得到用户的认可，能够活下去。

随着互联网的高速发展，互联网巨头公司能够产出越来越多的新兴软件，对技术挑战，对于小公司十年如一日的使用LNMP黄金架构即可开发自己的网站，该架构便宜又简单，对付一个中小网站绰绰有余。